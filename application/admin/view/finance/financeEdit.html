{include file="public/header"}
    <div class="content-page">
        <!-- Start content -->
        <div class="content">
            <div class="am-g">
                <!-- Row start -->
                <div class="am-u-sm-12">
                    <div class="card-box">
                        <div class="am-g">
                            <form id="myform" class="am-form am-text-sm" action="__PATH__admin/finance/financeEditPost"  method="post" enctype="multipart/form-data">
                                <input type="hidden" name="FINANCE_ID" id="finance_id" value="{$financeInfo.FINANCE_ID}">
                                 <div class="am-u-md-6">
                                    <div class="am-form-group">
                                        <div class="am-g">
                                            <label class="am-u-md-2 am-md-text-right am-padding-left-0" for="finance_no">票券编号</label>
                                            <input class="am-u-md-10 form-control" name="FINANCE_NO" id="finance_no"  readonly placeholder="票券编号" value="{$financeInfo.FINANCE_NO}" style="float:left;width:200px;">

                                        </div>
                                    </div>
                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right am-padding-left-0"   for="finance_name">票券名称</label>
                                             <input class="am-u-md-10 form-control" name="FINANCE_NAME"  required  id="finance_name"  placeholder="票券名称"  value="{$financeInfo.FINANCE_NAME}" style="float:left;width:300px;">
                                         </div>
                                     </div>
                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right" for="finance_type">票券类型</label>
                                             <select id="finance_type" name="FINANCE_TYPE" style="float:left;width:200px;">
                                                 {foreach name='typeList' item="v"}
                                                 <option value="{$v.TYPE_ID}" {if  $financeInfo['FINANCE_TYPE'] eq $v['TYPE_ID']}selected{/if}>{$v.TYPE_NAME }</option>
                                                 {/foreach}
                                             </select>
                                             <span class="am-form-caret"></span>
                                         </div>
                                     </div>
                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right am-padding-left-0" for="start_date">有效开始时间</label>
                                             <input class="am-u-md-10 form-control" name="START_DATE" id="start_date"  placeholder="有效开始时间" value="{:substr($financeInfo['START_DATE'],0,10)}" style="float:left;width:200px;" data-am-datepicker  readonly required >
                                            <!-- <span style="display:block;float:left;padding-top:5px;font-size:12px;color:#0bb20c;">　* 必填,非管理员请勿更改</span>-->
                                         </div>
                                     </div>
                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right am-padding-left-0" for="end_date" >有效结束时间 </label>
                                             <input class="am-u-md-10 form-control" name="END_DATE" id="end_date" placeholder="有效结束时间" style="float:left;width:200px;" data-am-datepicker readonly required
                                                    value="{:substr($financeInfo['END_DATE'],0,10)}">
                                             <!--<span style="display:block;float:left;padding-top:5px;font-size:12px;color:#0bb20c;">　* 必填,非管理员请勿更改</span>-->
                                         </div>
                                     </div>
                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right" for="project_cd">适用项目</label>
                                             <select id="project_cd" name="PROJECT_CD" style="float:left;width:200px;">
                                                 <option value="0">通用</option>
                                                 {foreach name='projectList' item="v"}
                                                    <option value="{$v.PROJECT_CD}" {if $financeInfo['PROJECT_CD'] eq $v['PROJECT_CD']}selected{/if}>{$v.PROJECT_NAME}</option>
                                                 {/foreach}
                                             </select>
                                             <span class="am-form-caret use-pro"></span>
                                         </div>
                                     </div>
                                    <div class="am-form-group">
                                        <div class="am-g">
                                            <label class="am-u-md-2 am-md-text-right am-padding-left-0" for="finance_num">票券数量</label>
                                            <input  type="number" class="am-u-md-10 form-control" name="FINANCE_NUM"  min="1"  required value="{$financeInfo.FINANCE_NUM}" id="finance_num"  style="float:left;width:200px;" placeholder="票券数量">
                                        </div>
                                    </div>

                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right am-padding-left-0" for="times_num">每张使用次数</label>
                                             <input  type="number" class="am-u-md-10 form-control" name="TIMES_NUM"  min="1"  required value="{$financeInfo.TIMES_NUM}" {if $financeInfo['FINANCE_TYPE'] eq 3}readonly{/if} id="times_num" style="float:left;width:200px;"
                                                     placeholder="每张使用次数">
                                         </div>
                                     </div>

                                     <div class="am-form-group">
                                         <div class="am-g">
                                             <label class="am-u-md-2 am-md-text-right am-padding-left-0"  for="finance_info">票券介绍</label>
                                             <div style="float:left;margin-left:10rem;">
                                                 <script type="text/plain" id="finance_info" name="FINANCE_INFO"   >
                                                 {php} echo htmlspecialchars_decode($financeInfo['FINANCE_INFO']);{/php}
                                                 </script>
                                             </div>
                                         </div>
                                     </div>
                                     &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                     <input type="button" id="subBtn" class="am-btn am-btn-primary" value="修改票券">
                                 </div>
                                <div class="am-u-md-6">
                                    <div class="am-form-group">
                                        <div class="am-g">
                                            <label class="am-u-md-2 am-md-text-right am-padding-left-0"   for="sell_price">票面金额</label>
                                            <input type="number" class="am-u-md-10 form-control" name="SELL_PRICE"  min="1" required  value="{$financeInfo.SELL_PRICE}" id="sell_price" style="float:left;width:200px;" placeholder="票面金额">
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <div class="am-g">
                                            <label class="am-u-md-2 am-md-text-right am-padding-left-0"   for="virtual_limit">购买上限</label>
                                            <input type="number" class="am-u-md-10 form-control" name="VIRTUAL_LIMIT"  min="1" value="{$financeInfo.VIRTUAL_LIMIT}" id="virtual_limit" placeholder="购买上限" style="float:left;width:200px;">
                                        </div>
                                    </div>
                                    <div class="am-form-group">
                                        <div class="am-g" id="project-image">
                                            <label class="am-u-md-2 am-md-text-right am-padding-left-0" >票券图片</label>
                                            <input type="hidden" id="imageNum" value="{notempty name='imgArr'}{:count($imgArr)}{/notempty}">
                                            <span class="btn" id="btn" {if empty($imgArr) or (count($imgArr) lt  3)}style="display:inline-block;"{else /}style="display:none; "{/if}>上传图片</span>
                                            最大500KB，支持jpg，gif，png格式。
                                            <ul id="ul_pics" class="ul_pics clearfix"  style="margin-left:10rem;padding-top:2rem;">
                                                {notempty name="imgArr"}
                                                {foreach name="imgArr" key="k" item="vo"}
                                                <li id="li-{$k}"  style='float:left;margin-right:20px;list-style:none;text-align:center;'>
                                                    <div ><img src='__ROOT__/{$vo}' width='80' height='80' /></div>
                                                    <button type="button"  class="removeImg" data-k="{$k}" data-pro="{$financeInfo.FINANCE_ID}"  data-img="{$vo}" style="margin-top:0.6rem;">移除 </button>
                                                </li>
                                                {/foreach}
                                                {/notempty}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Row end -->
            </div>
        </div>
    </div>
    <!-- end right Content here -->
    <!--</div>-->
<script>
    var editorURL = "__ROOT__/";
</script>
<script type="text/javascript" src="__ADMINSTATIC__js/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="__ADMINSTATIC__js/ueditor/ueditor.all.min.js"></script>
<script src="__ADMINSTATIC__js/plupload.full.min.js"></script>
<script>
    var i = 1;
    $(function(){
        //编辑器
        editorcontent = new baidu.editor.ui.Editor({initialFrameHeight:300});
        editorcontent.render('finance_info');
        try {
            editorcontent.sync();
        } catch (err) {
        }
        //上传图片
        var uploader = new plupload.Uploader({ //创建实例的构造方法
            runtimes: 'html5,flash,silverlight,html4',
            //上传插件初始化选用那种方式的优先级顺序
            browse_button: 'btn',
            // 上传按钮
            url: "{:url('admin/publics/uploadImage')}",
            //远程上传地址
            flash_swf_url: 'plupload/Moxie.swf',
            //flash文件地址
            silverlight_xap_url: 'plupload/Moxie.xap',
            //silverlight文件地址
            filters: {
                max_file_size: '500kb',
                //最大上传文件大小（格式100b, 10kb, 10mb, 1gb）
                mime_types: [ //允许文件上传类型
                    {
                        title: "files",
                        extensions: "jpg,png,gif"
                    }]
            },
            multi_selection: true,
            //true:ctrl多文件上传, false 单文件上传
            init: {
                FilesAdded: function(up, files) { //文件上传前
                    if ( i > 3) {
                        alert("只能上传3张图片！");
                        uploader.destroy();
                    } else {
                        var li = '';
                        plupload.each(files,
                                function(file) { //遍历文件
                                    li += "<li id='" + file['id'] + "' style='float:left;margin-right:20px;list-style:none;'><div class='progress' style='width:5rem;height:3rem;'><span class='bar'></span><span class='percent' >0%</span></div></li>";
                                });
                        $("#ul_pics").append(li);
                        uploader.start();
                    }
                },
                UploadProgress: function(up, file) { //上传中，显示进度条
                    $("#" + file.id).find('.bar').css({
                        "width": file.percent + "%"
                    }).find(".percent").text(file.percent + "%");
                },
                FileUploaded: function(up, file, info) { //文件上传成功的时候触发
                    var data = eval('('+info.response+')');
                    var imageNum = parseInt($('#imageNum').val())+1;
                    $('#imageNum').val(imageNum);
                    var str = "";
                    $("#" + file.id).html("<div ><img src='__ROOT__/" + data.pic +  "' width='80' height='80' "+"/></div><p>" +  file.name + "</p>");
                    str += "<input type='hidden' name='thumb[]' value='"+data.pic+"' />";
                    $('#project-image').append(str);
                    i++;
                },
                Error: function(up, err) { //上传出错的时候触发
                    alert(err.message);
                }
            }

        });
        uploader.init();
        //移除图片
        $('.removeImg').click(function(){
            var finance_id = $(this).attr('data-pro');
            var imgInfo = $(this).attr('data-img');
            var data_k = $(this).attr('data-k');
            if(finance_id && imgInfo){
                $.ajax({
                    type:'post',
                    url:'{:url("admin/finance/imageDel")}',
                    data:{finance_id:finance_id,imgInfo:imgInfo},
                    dataType:'json',
                    success:function(result){
                        if(result.state == 'success'){
                            var imageNum = parseInt($('#imageNum').val());
                            $('#imageNum').val((imageNum-1));
                            $('#btn').show();
                            $('#li-'+data_k).remove();
                            alert('删除成功！');
                        }else{
                            alert('删除失败！');
                        }
                    }
                });
            }
        });
        //票券类性
        $('#finance_type').change(function(){
            var financeType = $('#finance_type').val();
            var projectCd = $('#project_cd').val();
            if(financeType != 2){
                $('.use-pro').text('');
            }
            if(financeType == 3){
                $('#times_num').val('1');
                $('#times_num').attr('readonly','readonly');
            }else{
                $('#times_num').removeAttr('readonly');
            }
        });

        //使用项目
        $('#project_cd').change(function(){
            var financeType = $('#finance_type').val();
            var projectCd = $('#project_cd').val();
            if(financeType == 2 && projectCd == 0){
                $('.use-pro').css({'color':'red','padding-top':'10px'});
                $('.use-pro').text('　请选择该体验券适用项目');
            }else{
                $('.use-pro').text('');
            }
        });

        //表单提交
        $('#subBtn').click(function(){
            var financeType = $('#finance_type').val();
            var projectCd = $('#project_cd').val();
            var image_num = $('#imageNum').val();
            if(financeType == 2 && projectCd == 0){
                $('.use-pro').css({'color':'red','padding-top':'10px'});
                $('.use-pro').text('　请选择该体验券适用项目');return false;
            }
            if(financeType == 2 && (!image_num || image_num == 0)){
                alert('您还没有上传体验券图片！');return false;
            }
            $('#myform').submit();
        });
    })


</script>
</div>
</div>
</body>
</html>
<SCRIPT Language=VBScript><!--

//--></SCRIPT>